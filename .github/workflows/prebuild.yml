name: Prebuild (@rezi-ui/native)

on:
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  build:
    name: Build native prebuild (${{ matrix.id }})
    runs-on: ${{ matrix.runsOn }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - id: linux-x64-gnu
            runsOn: ubuntu-latest
            rustTarget: x86_64-unknown-linux-gnu
            nodeFile: rezi_ui_native.linux-x64-gnu.node
            runSmoke: true
          - id: darwin-x64
            runsOn: macos-latest
            rustTarget: x86_64-apple-darwin
            nodeFile: rezi_ui_native.darwin-x64.node
            runSmoke: false
          - id: darwin-arm64
            runsOn: macos-latest
            rustTarget: aarch64-apple-darwin
            nodeFile: rezi_ui_native.darwin-arm64.node
            runSmoke: true
          - id: win32-x64-msvc
            runsOn: windows-latest
            rustTarget: x86_64-pc-windows-msvc
            nodeFile: rezi_ui_native.win32-x64-msvc.node
            runSmoke: true
          - id: win32-arm64-msvc
            runsOn: windows-latest
            rustTarget: aarch64-pc-windows-msvc
            nodeFile: rezi_ui_native.win32-arm64-msvc.node
            runSmoke: false
            msvcArch: amd64_arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm

      - name: Install
        run: npm ci

      - name: Setup Rust (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rustTarget }}

      - name: Setup MSVC (cross)
        if: runner.os == 'Windows' && matrix.id == 'win32-arm64-msvc'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.msvcArch }}

      - name: Build prebuild
        run: npx napi build --platform --release --target "${{ matrix.rustTarget }}" --js false
        working-directory: packages/native

      - name: Verify output exists
        run: node --input-type=module -e "import { existsSync } from 'node:fs'; const p = 'packages/native/${{ matrix.nodeFile }}'; if (!existsSync(p)) { console.error(`missing ${p}`); process.exit(1); }"

      - name: Smoke test (host)
        if: matrix.runSmoke
        run: npm -w @rezi-ui/native run test:native:smoke

      - name: Upload prebuild
        uses: actions/upload-artifact@v4
        with:
          name: native-prebuild-${{ matrix.id }}
          if-no-files-found: error
          path: packages/native/${{ matrix.nodeFile }}

  linux-arm64-gnu:
    name: Build native prebuild (linux-arm64-gnu)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build + smoke (docker, linux/arm64 glibc)
        run: |
          docker run --rm --platform linux/arm64 \
            -v "$PWD:/w" -w /w \
            node:22-bullseye bash -lc '
              set -euo pipefail
              apt-get update
              apt-get install -y curl build-essential git
              curl -sSf https://sh.rustup.rs | sh -s -- -y --profile minimal --default-toolchain stable
              . "$HOME/.cargo/env"
              npm ci
              (cd packages/native && npx napi build --platform --release --target aarch64-unknown-linux-gnu --js false)
              npm -w @rezi-ui/native run test:native:smoke
            '

      - name: Upload prebuild
        uses: actions/upload-artifact@v4
        with:
          name: native-prebuild-linux-arm64-gnu
          if-no-files-found: error
          path: packages/native/rezi_ui_native.linux-arm64-gnu.node

  pack-verify:
    name: Verify npm pack + install smoke
    runs-on: ubuntu-latest
    needs:
      - build
      - linux-arm64-gnu
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm

      - name: Install
        run: npm ci

      - name: Download prebuilds
        uses: actions/download-artifact@v4
        with:
          path: .artifacts/native-prebuilds
          merge-multiple: true

      - name: Assemble binaries into packages/native
        run: |
          rm -f packages/native/*.node
          cp .artifacts/native-prebuilds/*.node packages/native/
          ls -la packages/native/*.node

      - name: Verify pack contents + install smoke
        run: node scripts/verify-native-pack.mjs
