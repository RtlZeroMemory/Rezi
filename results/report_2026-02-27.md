# Ink vs Ink-Compat Benchmark Report (2026-02-27)

This report summarizes the first benchmark matrix run and the latest post-optimization results.

## Validity status

- Final-screen equivalence checks pass for:
  - `streaming-chat`
  - `large-list-scroll`
  - `dashboard-grid`
  - `style-churn`
- `resize-storm` is currently **invalid** (final screen mismatch) and excluded.

Verification command:

```bash
for s in streaming-chat large-list-scroll dashboard-grid style-churn; do
  npm run -s verify -- --scenario "$s" --compare real-ink,ink-compat --out results/
done
```

Methodology + metric definitions: `BENCHMARK_VALIDITY.md`.

## First benchmark matrix run (baseline)

Baseline batches (3 runs each):

- streaming-chat: `results/ink-bench_streaming-chat_real-ink_2026-02-27T16-53-44-910Z`, `results/ink-bench_streaming-chat_ink-compat_2026-02-27T16-53-58-327Z`
- large-list-scroll: `results/ink-bench_large-list-scroll_real-ink_2026-02-27T16-54-11-519Z`, `results/ink-bench_large-list-scroll_ink-compat_2026-02-27T16-54-27-799Z`
- dashboard-grid: `results/ink-bench_dashboard-grid_real-ink_2026-02-27T16-54-43-532Z`, `results/ink-bench_dashboard-grid_ink-compat_2026-02-27T16-54-55-795Z`
- style-churn: `results/ink-bench_style-churn_real-ink_2026-02-27T16-55-07-624Z`, `results/ink-bench_style-churn_ink-compat_2026-02-27T16-55-21-208Z`

Key findings:

- `ink-compat` already had a **large CPU advantage** vs Ink (≈ `-17%` to `-48%` totalCpuTimeS).
- However, `ink-compat` emitted **far more frames** in `dashboard-grid`, `style-churn`, and `streaming-chat`, inflating total render work:
  - `dashboard-grid` renderTotal was **worse** (`+36%`) because frames were ~`+74%`.

## Changes made (tied to measurements)

1. **Fair measurement for Ink layout**
   - Real Ink `renderTime` excludes Yoga layout; we instrumented Yoga layout via a preload and include it as `layoutTimeMs` so `renderTotalMs` is comparable.
   - Code: `scripts/ink-compat-bench/preload.mjs`.

2. **Reduce translation churn (ink-compat)**
   - Avoid bumping host node revisions when props/text are semantically unchanged.
   - Code: `packages/ink-compat/src/reconciler/types.ts`.

3. **Fix throttling/coalescing mismatch (ink-compat)**
   - Implement Ink-like commit render throttling (debounce+maxWait style) so `maxFps` coalesces similarly and doesn’t emit ~1 frame per update under 60Hz update streams.
   - Keep resize redraw correctness with microtask coalescing (fast redraw + burst coalescing).
   - Code: `packages/ink-compat/src/runtime/render.ts`.

## Latest benchmark matrix run (current)

Current batches (3 runs each):

- streaming-chat: `results/ink-bench_streaming-chat_real-ink_2026-02-27T17-32-35-383Z`, `results/ink-bench_streaming-chat_ink-compat_2026-02-27T17-32-48-793Z`
- large-list-scroll: `results/ink-bench_large-list-scroll_real-ink_2026-02-27T17-33-01-880Z`, `results/ink-bench_large-list-scroll_ink-compat_2026-02-27T17-33-18-040Z`
- dashboard-grid: `results/ink-bench_dashboard-grid_real-ink_2026-02-27T17-33-33-711Z`, `results/ink-bench_dashboard-grid_ink-compat_2026-02-27T17-33-45-750Z`
- style-churn: `results/ink-bench_style-churn_real-ink_2026-02-27T17-33-57-492Z`, `results/ink-bench_style-churn_ink-compat_2026-02-27T17-34-10-830Z`

### Summary (ink-compat vs real-ink)

| Scenario | meanWallS | totalCpuTimeS | meanRenderTotalMs | peakRSS | framesEmitted |
|---|---:|---:|---:|---:|---:|
| streaming-chat | **-3.8%** | **-41.6%** | **-48.2%** | **-28.9%** | -2.1% |
| large-list-scroll | **-3.3%** | **-38.4%** | **-29.1%** | **-29.0%** | -0.8% |
| dashboard-grid | **-4.7%** | **-28.3%** | **-0.4%** | **-26.5%** | -4.0% |
| style-churn | **-3.0%** | **-56.1%** | **-77.6%** | **-53.7%** | -0.7% |

Notes:

- `dashboard-grid` renderTotal is now essentially matched (and slightly better), while CPU is still ~`-28%`.
- `style-churn` is a decisive win: large reductions in CPU, render time, and peak RSS.

## Before/After deltas for ink-compat (baseline → current)

The biggest single improvement came from fixing frame coalescing under `maxFps`:

- `dashboard-grid`:
  - frames: **136 → 72** (`-46.8%`)
  - renderTotal: **121ms → 81ms** (`-33.1%`)
  - cpu: **0.653s → 0.533s** (`-18.4%`)
- `style-churn`:
  - frames: **174 → 92** (`-46.9%`)
  - renderTotal: **131ms → 83ms** (`-37.0%`)
  - cpu: **0.697s → 0.553s** (`-20.6%`)
- `streaming-chat`:
  - frames: **178 → 122** (`-31.6%`)
  - renderTotal: **122ms → 90ms** (`-26.6%`)
  - cpu: **0.683s → 0.617s** (`-9.8%`)

## Profiling artifacts

CPU profiles are generated via:

```bash
npm run -s bench -- --scenario dashboard-grid --renderer ink-compat --runs 1 --cpu-prof --out results/
```

Latest example profiles (one-run captures):

- Ink: `results/ink-bench_dashboard-grid_real-ink_2026-02-27T17-29-17-074Z/run_01/cpu-prof/dashboard-grid_real-ink_run1.cpuprofile`
- ink-compat: `results/ink-bench_dashboard-grid_ink-compat_2026-02-27T17-29-23-291Z/run_01/cpu-prof/dashboard-grid_ink-compat_run1.cpuprofile`

Helper (top self-time + stacks):

```bash
node scripts/ink-compat-bench/summarize-cpuprofile.mjs <file.cpuprofile> --top 25 --stacks 10
```

## Top hotspots (CPU profiles)

Percentages below come from `summarize-cpuprofile.mjs --active` (**non-idle samples only**) on the `dashboard-grid` one-run profiles.

### real-ink (Ink)

Cpuprofile:

- `results/ink-bench_dashboard-grid_real-ink_2026-02-27T17-29-17-074Z/run_01/cpu-prof/dashboard-grid_real-ink_run1.cpuprofile`

Hotspots (`--filter ink/build`):

- `ink/build/output.js` buffer/write path — **0.5% self** (`get`)
  - stack: `resetAfterCommit -> onRender -> renderer -> get (output.js)`
- `ink/build/render-node-to-output.js` — **0.4% self** (`renderNodeToOutput`)
  - stack: `resetAfterCommit -> onRender -> renderer -> renderNodeToOutput`
- Yoga layout (measured via preload) — **0.2% self** (`calculateLayout`)
  - stack: `resetAfterCommit -> rootNode.onComputeLayout (preload.mjs) -> calculateLayout`

### ink-compat (Rezi-backed)

Cpuprofile:

- `results/ink-bench_dashboard-grid_ink-compat_2026-02-27T17-29-23-291Z/run_01/cpu-prof/dashboard-grid_ink-compat_run1.cpuprofile`

Hotspots (`--filter packages/`):

- `packages/core/dist/renderer/renderToDrawlist.js` — **0.9% self** (`renderToDrawlist`)
  - stack: `commitRoot -> resetAfterCommit -> bridge.rootNode.onCommit -> renderFrame -> renderToDrawlist`
- `packages/core/dist/layout/kinds/box.js` — **0.8% self** (`layoutBoxKinds`)
  - stack: `layoutNode -> layoutStack -> layoutNode -> layoutBoxKinds`
- `packages/ink-compat/dist/runtime/render.js` — **0.6% self** (`flushPendingRender`)
  - stack: `commitRoot -> resetAfterCommit -> bridge.rootNode.onCommit -> scheduleRender -> flushPendingRender`
