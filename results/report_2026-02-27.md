# Ink vs Ink-Compat Benchmark Report (2026-02-27)

This report summarizes the first benchmark matrix run and the latest post-optimization results.

## Validity status

- Final-screen equivalence checks pass for:
  - `streaming-chat`
  - `large-list-scroll`
  - `dashboard-grid`
  - `style-churn`
- `resize-storm` is currently **invalid** (final screen mismatch) and excluded.

Verification command:

```bash
for s in streaming-chat large-list-scroll dashboard-grid style-churn; do
  npm run -s verify -- --scenario "$s" --compare real-ink,ink-compat --out results/
done
```

Methodology + metric definitions: `BENCHMARK_VALIDITY.md`.

## First benchmark matrix run (baseline)

Baseline batches (3 runs each):

- streaming-chat: `results/ink-bench_streaming-chat_real-ink_2026-02-27T16-53-44-910Z`, `results/ink-bench_streaming-chat_ink-compat_2026-02-27T16-53-58-327Z`
- large-list-scroll: `results/ink-bench_large-list-scroll_real-ink_2026-02-27T16-54-11-519Z`, `results/ink-bench_large-list-scroll_ink-compat_2026-02-27T16-54-27-799Z`
- dashboard-grid: `results/ink-bench_dashboard-grid_real-ink_2026-02-27T16-54-43-532Z`, `results/ink-bench_dashboard-grid_ink-compat_2026-02-27T16-54-55-795Z`
- style-churn: `results/ink-bench_style-churn_real-ink_2026-02-27T16-55-07-624Z`, `results/ink-bench_style-churn_ink-compat_2026-02-27T16-55-21-208Z`

Key findings:

- `ink-compat` already had a **large CPU advantage** vs Ink (≈ `-17%` to `-48%` totalCpuTimeS).
- However, `ink-compat` emitted **far more frames** in `dashboard-grid`, `style-churn`, and `streaming-chat`, inflating total render work:
  - `dashboard-grid` renderTotal was **worse** (`+36%`) because frames were ~`+74%`.

## Changes made (tied to measurements)

1. **Fair measurement for Ink layout**
   - Real Ink `renderTime` excludes Yoga layout; we instrumented Yoga layout via a preload and include it as `layoutTimeMs` so `renderTotalMs` is comparable.
   - Code: `scripts/ink-compat-bench/preload.mjs`.

2. **Reduce translation churn (ink-compat)**
   - Avoid bumping host node revisions when props/text are semantically unchanged.
   - Code: `packages/ink-compat/src/reconciler/types.ts`.

3. **Fix throttling/coalescing mismatch (ink-compat)**
   - Implement Ink-like commit render throttling (debounce+maxWait style) so `maxFps` coalesces similarly and doesn’t emit ~1 frame per update under 60Hz update streams.
   - Keep resize redraw correctness with microtask coalescing (fast redraw + burst coalescing).
   - Code: `packages/ink-compat/src/runtime/render.ts`.

## Latest benchmark matrix run (current)

Current batches (3 runs each):

- streaming-chat: `results/ink-bench_streaming-chat_real-ink_2026-02-27T17-32-35-383Z`, `results/ink-bench_streaming-chat_ink-compat_2026-02-27T17-32-48-793Z`
- large-list-scroll: `results/ink-bench_large-list-scroll_real-ink_2026-02-27T17-33-01-880Z`, `results/ink-bench_large-list-scroll_ink-compat_2026-02-27T17-33-18-040Z`
- dashboard-grid: `results/ink-bench_dashboard-grid_real-ink_2026-02-27T17-33-33-711Z`, `results/ink-bench_dashboard-grid_ink-compat_2026-02-27T17-33-45-750Z`
- style-churn: `results/ink-bench_style-churn_real-ink_2026-02-27T17-33-57-492Z`, `results/ink-bench_style-churn_ink-compat_2026-02-27T17-34-10-830Z`

### Summary (ink-compat vs real-ink)

| Scenario | meanWallS | totalCpuTimeS | meanRenderTotalMs | peakRSS | framesEmitted |
|---|---:|---:|---:|---:|---:|
| streaming-chat | **-3.8%** | **-41.6%** | **-48.2%** | **-28.9%** | -2.1% |
| large-list-scroll | **-3.3%** | **-38.4%** | **-29.1%** | **-29.0%** | -0.8% |
| dashboard-grid | **-4.7%** | **-28.3%** | **-0.4%** | **-26.5%** | -4.0% |
| style-churn | **-3.0%** | **-56.1%** | **-77.6%** | **-53.7%** | -0.7% |

Notes:

- `dashboard-grid` renderTotal is now essentially matched (and slightly better), while CPU is still ~`-28%`.
- `style-churn` is a decisive win: large reductions in CPU, render time, and peak RSS.

## Before/After deltas for ink-compat (baseline → current)

The biggest single improvement came from fixing frame coalescing under `maxFps`:

- `dashboard-grid`:
  - frames: **136 → 72** (`-46.8%`)
  - renderTotal: **121ms → 81ms** (`-33.1%`)
  - cpu: **0.653s → 0.533s** (`-18.4%`)
- `style-churn`:
  - frames: **174 → 92** (`-46.9%`)
  - renderTotal: **131ms → 83ms** (`-37.0%`)
  - cpu: **0.697s → 0.553s** (`-20.6%`)
- `streaming-chat`:
  - frames: **178 → 122** (`-31.6%`)
  - renderTotal: **122ms → 90ms** (`-26.6%`)
  - cpu: **0.683s → 0.617s** (`-9.8%`)

## Profiling artifacts

CPU profiles are generated via:

```bash
npm run -s bench -- --scenario dashboard-grid --renderer ink-compat --runs 1 --cpu-prof --out results/
```

Latest example profiles (one-run captures):

- Ink: `results/ink-bench_dashboard-grid_real-ink_2026-02-27T17-29-17-074Z/run_01/cpu-prof/dashboard-grid_real-ink_run1.cpuprofile`
- ink-compat: `results/ink-bench_dashboard-grid_ink-compat_2026-02-27T17-29-23-291Z/run_01/cpu-prof/dashboard-grid_ink-compat_run1.cpuprofile`

Helper (top self-time + stacks):

```bash
node scripts/ink-compat-bench/summarize-cpuprofile.mjs <file.cpuprofile> --top 25 --stacks 10
```

## Top hotspots (CPU profiles)

Percentages below come from `summarize-cpuprofile.mjs --active` (**non-idle samples only**) on the `dashboard-grid` one-run profiles.

### real-ink (Ink)

Cpuprofile:

- `results/ink-bench_dashboard-grid_real-ink_2026-02-27T17-29-17-074Z/run_01/cpu-prof/dashboard-grid_real-ink_run1.cpuprofile`

Hotspots (`--filter ink/build`):

- `ink/build/output.js` buffer/write path — **0.5% self** (`get`)
  - stack: `resetAfterCommit -> onRender -> renderer -> get (output.js)`
- `ink/build/render-node-to-output.js` — **0.4% self** (`renderNodeToOutput`)
  - stack: `resetAfterCommit -> onRender -> renderer -> renderNodeToOutput`
- Yoga layout (measured via preload) — **0.2% self** (`calculateLayout`)
  - stack: `resetAfterCommit -> rootNode.onComputeLayout (preload.mjs) -> calculateLayout`

### ink-compat (Rezi-backed)

Cpuprofile:

- `results/ink-bench_dashboard-grid_ink-compat_2026-02-27T17-29-23-291Z/run_01/cpu-prof/dashboard-grid_ink-compat_run1.cpuprofile`

Hotspots (`--filter packages/`):

- `packages/core/dist/renderer/renderToDrawlist.js` — **0.9% self** (`renderToDrawlist`)
  - stack: `commitRoot -> resetAfterCommit -> bridge.rootNode.onCommit -> renderFrame -> renderToDrawlist`
- `packages/core/dist/layout/kinds/box.js` — **0.8% self** (`layoutBoxKinds`)
  - stack: `layoutNode -> layoutStack -> layoutNode -> layoutBoxKinds`
- `packages/ink-compat/dist/runtime/render.js` — **0.6% self** (`flushPendingRender`)
  - stack: `commitRoot -> resetAfterCommit -> bridge.rootNode.onCommit -> scheduleRender -> flushPendingRender`

## Incremental update (runtime-path cleanup, 18:33 UTC)

New verify runs (all valid scenarios pass final-screen equivalence):

- `results/verify_streaming-chat_2026-02-27T18-32-23-185Z.json`
- `results/verify_large-list-scroll_2026-02-27T18-32-31-254Z.json`
- `results/verify_dashboard-grid_2026-02-27T18-32-39-124Z.json`
- `results/verify_style-churn_2026-02-27T18-32-48-767Z.json`

New dashboard-grid batches:

- real-ink (3 runs): `results/ink-bench_dashboard-grid_real-ink_2026-02-27T18-32-59-956Z`
- ink-compat (3 runs): `results/ink-bench_dashboard-grid_ink-compat_2026-02-27T18-33-15-205Z`
- ink-compat detail (3 runs): `results/ink-bench_dashboard-grid_ink-compat_2026-02-27T18-33-29-979Z`

Changes in this increment:

- `packages/core/src/testing/renderer.ts`: runtime-mode `nodes` became lazy, plus `forEachLayoutNode` hot-path traversal.
- `packages/ink-compat/src/runtime/render.ts`: host layout assignment + rect scans use `forEachLayoutNode` (no eager node materialization on default path).
- `packages/ink-compat/src/runtime/render.ts`: replaced commit signature string building with numeric revision tracking.

### Dashboard-grid delta (pre-increment → post-increment)

Comparison:

- before: `results/ink-bench_dashboard-grid_real-ink_2026-02-27T18-22-36-968Z` vs `results/ink-bench_dashboard-grid_ink-compat_2026-02-27T18-22-49-054Z`
- after: `results/ink-bench_dashboard-grid_real-ink_2026-02-27T18-32-59-956Z` vs `results/ink-bench_dashboard-grid_ink-compat_2026-02-27T18-33-15-205Z`

ink-compat vs real-ink (after):

- `meanRenderTotalMs`: **-8.9%** (ink-compat faster)
- `renderTotalP95Ms`: **+10.4%** (tail still slower)
- `totalCpuTimeS`: **-31.1%**
- `framesEmitted`: **-4.8%**

ink-compat before → after:

- `meanRenderTotalMs`: **77.72ms → 75.58ms** (`-2.8%`)
- `renderTotalP95Ms`: **1.94ms → 1.83ms** (`-5.9%`)
- `renderTotalP99Ms`: **2.80ms → 2.65ms** (`-5.3%`)
- `totalCpuTimeS`: **0.543s → 0.523s** (`-3.7%`)

### Phase evidence (detail run)

Detail batch: `results/ink-bench_dashboard-grid_ink-compat_2026-02-27T18-33-29-979Z`

- Outliers remain early-frame and mostly `coreRenderMs` dominated (single-pass; `coreRenderPasses=1` on >2ms frames).
- Representative spikes:
  - `run_01 frame 2`: `renderTotalMs=3.96`, `coreRenderMs=3.63`, `ansiMs=0.25`
  - `run_01 frame 3`: `renderTotalMs=3.52`, `coreRenderMs=2.99`, `translationMs=0.34`
  - `run_03 frame 5`: `renderTotalMs=2.80`, `coreRenderMs=1.61`, `ansiMs=0.90`

## Top hotspots (latest one-run CPU profiles)

Latest cpuprofiles:

- ink-compat: `results/ink-bench_dashboard-grid_ink-compat_2026-02-27T18-33-45-835Z/run_01/cpu-prof/dashboard-grid_ink-compat_run1.cpuprofile`
- real-ink: `results/ink-bench_dashboard-grid_real-ink_2026-02-27T18-33-54-236Z/run_01/cpu-prof/dashboard-grid_real-ink_run1.cpuprofile`

Percentages below are from `summarize-cpuprofile.mjs --active`.

### real-ink

- `readFileUtf8` startup/module-load work — **8.2% self**
- `ink/build/output.js:get` output assembly — **0.7% self**
  - stack: `resetAfterCommit -> onRender -> renderer -> get (output.js)`
- `ansi-tokenize/build/styledCharsFromTokens` — **0.9% self**
  - stack: `resetAfterCommit -> onRender -> renderer -> get -> applyWriteOperation -> toStyledCharacters -> styledCharsFromTokens`
- `string-width` path in text measurement — **1.5% self**
  - stack: `measureTextNode -> measureStyledChars -> styledCharsWidth -> inkCharacterWidth -> stringWidth`

### ink-compat

- `compileSourceTextModule` / `internalModuleReadJSON` startup/module-load work — **7.2% / 6.7% self**
- `packages/core/dist/layout/validateProps.js:validateLayoutConstraints` — **1.0% self**
  - stack: `layoutStack -> planConstraintMainSizes -> measureMinContent -> measureBoxIntrinsic -> validateBoxProps -> validateLayoutConstraints`
- `packages/core/dist/layout/textMeasure.js:wrapTextToLines` — **0.7% self**
  - stack: `measureLeaf -> measureTextWrapped -> wrapTextToLines`
- `packages/ink-compat/dist/translation/propsToVNode.js:translateNode` — **0.6% self**
  - stack: `translateNodeUncached -> translateBox -> translateNode`

### Eliminated hot-path items from prior profile

Previous profile (before this increment):

- `results/ink-bench_dashboard-grid_ink-compat_2026-02-27T18-23-12-600Z/run_01/cpu-prof/dashboard-grid_ink-compat_run1.cpuprofile`
- `collectNodes` (`packages/core/dist/testing/renderer.js`) — **0.3% self**
- `rootChildRevisionSignature` (`packages/ink-compat/dist/runtime/render.js`) — **0.3% self**

Current profile (`18-33-45-835Z`) no longer shows either symbol in top filtered output.
